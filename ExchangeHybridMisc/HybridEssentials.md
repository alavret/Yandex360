# Гибридный режим работы Яндекс 360 и локальной почтовой системы (Exchange)
[!IMPORTANT]
> Гибридный режим подразумевает использование одного почтового домена для двух различных почтовых систем. При этом пользватели организации распределены между этими почтовыми системами. В случае Яндекс 360 особенностью гибридного режима является MX запись рабочего домена, которая смотрит на "землю" (в локальную почтовую систему, например, в Exchange). 
> При таком режиме все письма на рабочий домен из почтовых ящиков пользователей организации в Яндекс 360 маршрутизируются сразу в локальную систему (по адресу MX), даже если почтовый ящик получателя находится также в Яндекс 360. Далее уже задача транспорта локальной почтовой системы корректно обработать письмо и направить его получателю.
> Письма для других доменов (не принадлижащих органиазции) из почтовых ящиков Яндекс 360 передаются напрямую на SMTP сервер, указанный в MX записи для этого домена. 
> Т.е. другими словами, все исходящие письма на все домены отправляются на сервер, указанный в MX записи для домена в исходящем адресе письма (даже если ящик для этого адреса находится также в Яндекс 360).
 
> [!CAUTION]
> **Гибридный режим работы почты официально не поддерживается в Яндекс 360**.
> Если обеспечить корректную маршрутизацию почтовых сообщений между несколькими почтовыми системами, как правило, не представляет проблемы, то обеспечение корректного обмена календарными данными, глобальными адресными книгами, задачами и другой информацией - это большая интеграционная задача в связи с наличием различных подходов к форматам такой информации и её обработки.
> Microsoft приложил много усилий для популяризации своего клиента Outlook и подхода к работе с офисной информацией. Но взаимодействие сторонних продуктов с этими форматами и протоколами представляет проблему, т.к. форматы/протоколы являются проприентарными и закрытыми и лишь недавно MS стала публиковать документацию по ним. В свою очередь, Microsoft лишь частично реализовала в Outlook поддержку стандартных форматов и протоколов, принятых в Internet для работы, например, с календарной информацией.
## Краткая последовательность шагов по реализации гибридного режима работы почтовой системы на стороне локального сервера и Яндекс 360
> [!NOTE]
> Это базовая формула. Варианты реализации различются в зависимости от конфигурации почтовой системы конкретной организации.
- Предполагаем, что основной домен организации - `contoso.com`. Пользватели имеют SMTP адреса в этом домене.
- Добавляем в Яндекс 360 организацию данный домен, `contoso.com` как основной домен организации.
- Реплицируем выбранных для работы в почте и других сервисах Яндекс 360 пользователей из локальной Active Directory в организацию Яндекс 360 (с использованием утилиты SCIM).
- (Опционально) Реплицируем всех пользователей организации в список "Внешние контакты" для симуляции GAL в почтовых клиентах.
- Настраиваем SAML аутентификацию (например, через ADFS сервер). 
- Выбираем "сервисный" почтовый домен третьего уровня (наример, `360.contoso.com`) и также добавляем его в список доменов организации Яндекс 360.
- (Опционально) Настраиваем политику адресов исходящей почты для пользователей (чтобы у них не было возможности выбирать исходящий домен в настройках почты).
- Добавляем исходящий "белый" IP адрес локальной почтовой системы в "белый список" почтовых серверов для входящего трафика в Яндекс 360.
- Добавляем исходящие SMTP адреса Яндекс 360 в SPF список для основного почтовго домена организации.
- (Опциоанльно) Добавляем DKIM запись в DNS для возможности проверки сообщений, отправленных из Яндекс 360.
- Настраиваем локальный входящий SMTP сервер (выполняющий роль антиспама/антивируса) для работы с трафиком от SMTP серверов Яндекс 360. С Яндекс 360 (внешней почтовой системе по отношению к локальной системе) будут приходить письма с исходящим адресом в основном домене (user@contoso.com). Для любого антиспама это является признаком нарушения правил (spoofing) и такие письма автоматически блокируются. Необходимо добавить SMTP сервера Яндекс 360 в исключения этого правила. Безопасность при этом не пострадает - у злоумышленника с локальной учеткой в yandex.ru или учеткой в другой организации Яндекс 360 нет возможности отправить письмо от чужого имени/домена.
- Если в локальной организации установлен Exchange, устанавить дополнительные разрешения для сервисного домена в виде команд RemoteDomain:
```
New-RemoteDomain -Name "Yandex 360" -DomainName 360.contoso.com
Set-RemoteDomain -Identity  "Yandex 360" -AutoReplyEnabled $true -AutoForwardEnabled $true -All
owedOOFType InternalLegacy -DeliveryReportEnabled $true -NDREnabled $false -MeetingForwardNotificationEnabled $true
```
- Выбираем вариант сосуществования почтового ящика из локальной почтовой системы и в Яндекс 360:
    - создание второго ящика в Яндекс 360 и его наполнение с помощью серверной миграции почтовых ящиков через IMAP протокол;
    - создание второго ящика в Яндекс 360 и его наполнение с использованием правил личного почтового почтового ящика (если у пользователя основная почта - `andy@contoso.com`, то нужно создать правило  перенаправления с копированием всех писем на адрес `andy@360.contoso.com`)
    - создание второго ящика в Яндекс 360 и его наполнение с использованием опции перенапраления писем на стороне сервера. Например, в Exchange это может быть команда
    ```
    Set-Mailbox -Identity andy -DeliverToMailboxAndForward $true -ForwardingSMTPAddress "andy@360.contoso.com"
    ```
    -  создание второго ящика в Яндекс 360 и его наполнение через миграцию данных с помощью Outlook и PST файла.

После периода синхронизации почтовых ящиков и их одновременного сосуществоания и работы с ними выполняется удаление первичного ящика и работа продолжается с единственным ящиком в Яндекс 360. Как правило, в локальном Exchange для этого используют сценарий с преобразованием почтового ящика пользователя в объект MailEnebledUser с внешним адресом, например `andy@360.contoso.com`.
## Настройка дестопного клиента для работы с почтой Яндекс 360.
С почтой Яндекс 360 можно работать из Web интерфейса, а также из любого почтового клиента, который понимает IMAP/SMTP протокол.
Идеальным вариантом является Thunderbird - он понимает OAuth аутентификацию и имеет встроенную поддержку протоколов CalDAV и CardDAV, умеет автоматически подключать доступные пользователю общие ящиков.
При использовании клиента Outlook необходимо учитывать следующее:
- автонастройка Outlook (Autidiscovery процесс) для работы с IMAP протоколом возможна, но требует дополнительных усилий по разворачиванию в локальной сети соответствющего Web сервиса на базе Nginx для его реалиазации. 
- каждый пользователь самостоятельно должен получить в Web интерфейсе свой пароль приложений для работы с IMAP/SMTP сервером Яндекс 360. Outlook не умеет использовать OAuth протокол для аутентификации на сторонних IMAP сервисах.
- даже при наличии автонастройки параметров профиля IMAP пользователь должен участвовать в завершении настройки Outlook путём ввода пароля приложения для IMAP, полученным на предыдущем шаге.
- при необходимости подключения дополнительных (общих) ящиков к IMAP профилю пользователя в Outlook для каждого из них необходимо выполнить все настройки подключения вручную (имена серверов, алиас ящика, логин входа и пароль приложения). Сервис автообнаружения для такого сценария не работает.
- после создания профиля для возможности синхронизации в локальный профиль Outlook календарной и контактной информации из Яндекс 360 необходимо установить [Яндекс Коннектор для Microsoft Outlook](https://yandex.ru/support/yandex-360/business/calendar/ru/plug-in) и пройти в нем аутентификацию (процесс требует ввода кода в соответствующее окно лично пользователем).
## Миграция календарных данных из ящика Exchange в Яндекс 360.
Календарную информацию на начало 2025 года можно экапортировать двумя способами.
1. Экспорт содержимого ящика в файл в формате ical и импорт этого файла в сервис календаря в Яндекс 360.
2. Установка в Outlook, подключённого к ящику в Exchange, Яндекс Коннектор для Microsoft Outlook, и выполнения процедуры синхроннизации событий с ящиком в Яндекс 360 с использованием этого плагина. 
> [!CAUTION]
> На текущий момент времени (Январь 2025) есть кейсы, когда при большом количестве мигрируемых событий на часть из них коннектор не получает подтверждения миграции от бэкенда Яндекс 360. Из-за этого Коннектор удаляет такое неподтвержденное событие из ящика Exchange. В связи с этим до процедуры миграции настоятельно рекомендуется выполнять резервное копирование или самих событий или всего почтового ящика.